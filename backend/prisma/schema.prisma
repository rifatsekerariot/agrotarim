generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password_hash String
  created_at    DateTime @default(now())
  farms         Farm[]
}

model Farm {
  id          Int      @id @default(autoincrement())
  user_id     Int
  city        String
  district    String
  station_id  Int      // MGM Station ID
  crop_type   String?
  user        User     @relation(fields: [user_id], references: [id])
  polygon     Json?    // Storing coordinates as JSON
  plantingDate DateTime?
  devices     Device[]
  alertRules  AlertRule[]
  dashboardConfig Json?    // Stores custom dashboard layout: { widgets: [] }
  created_at  DateTime @default(now())
}

// LoRaWAN Network Server Management (ChirpStack v4, TTN, etc.)
model LoRaServer {
  id          Int      @id @default(autoincrement())
  name        String   // "Ana Sunucu", "Test Sunucu"
  serverType  String   @default("chirpstack_v4") // chirpstack_v4, ttn_v3, custom
  host        String   // "chirpstack.example.com"
  port        Int      @default(8080)
  
  // Authentication
  apiKey      String?  // ChirpStack API Token
  tenantId    String?  // ChirpStack Tenant ID (v4)
  
  // MQTT Connection
  mqttEnabled Boolean  @default(true)
  mqttHost    String?  // "tcp://chirpstack.example.com:1883"
  mqttUsername String?
  mqttPassword String?
  mqttTopic   String?  @default("application/+/device/+/event/up")
  
  // HTTP Webhook (Alternative to MQTT)
  httpEnabled Boolean  @default(false)
  httpSecret  String?  // Webhook signature verification
  
  isActive    Boolean  @default(true)
  lastSync    DateTime?
  
  devices     Device[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Device Model Templates (Milesight, Dragino, etc.)
// Note: Decoder not needed - ChirpStack sends pre-decoded JSON
model DeviceModel {
  id          Int      @id @default(autoincrement())
  brand       String   // "Milesight", "Dragino", "Custom"
  model       String   // "EM300-TH", "EM500-SMTC"
  category    String   // "temperature_humidity", "soil", "weather", "gateway"
  
  // Sensor Template - defines expected sensors for this model
  sensorTemplate Json   // [{code: "temperature", name: "Sıcaklık", unit: "°C"}, ...]
  
  // Visual & Info
  description String?
  
  devices     Device[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([brand, model])
}

// The physical hardware box (Node/Gateway)
model Device {
  id            Int      @id @default(autoincrement())
  farmId        Int
  farm          Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name          String   // e.g. "North Field Station"
  serialNumber  String   @unique // MAC or Unique Hardware ID
  
  // NEW: LoRaWAN Specific
  devEui        String?  @unique // LoRaWAN Device EUI (16 hex chars)
  appKey        String?  // Application Key for OTAA
  
  // NEW: Relations
  loraServerId  Int?
  loraServer    LoRaServer?  @relation(fields: [loraServerId], references: [id], onDelete: SetNull)
  
  deviceModelId Int?
  deviceModel   DeviceModel? @relation(fields: [deviceModelId], references: [id], onDelete: SetNull)
  
  // Legacy field (kept for backward compatibility, prefer deviceModel relation)
  model         String?  // e.g. "AgroNode-V1"
  firmwareVer   String?
  
  // Location
  latitude      Float?
  longitude     Float?

  // Status Monitoring
  batteryLevel  Int?     // Percentage
  signalQuality Int?     // RSSI or percentage
  status        String   @default("offline") // online, offline, maintenance
  lastSeen      DateTime?
  
  telemetryMappings Json? // Store custom parsing rules: {"temp": "t_air", "hum": "h_air"}

  sensors       Sensor[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// A specific probe on a defined Device (e.g. "Air Temp", "Soil Moisture Depth 1")
model Sensor {
  id          Int      @id @default(autoincrement())
  deviceId    Int
  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  name        String   // User friendly name: "Soil Sensor 1"
  code        String   // System identifier: "soil_vwc_1", "air_temp"
  type        String   // "temperature", "humidity", "moisture", "pressure"
  unit        String   // "C", "%", "hPa"
  
  telemetry   Telemetry[]
  alertRules  AlertRule[]
}

// Time-series data storage
model Telemetry {
  id        BigInt   @id @default(autoincrement()) // BigInt for millions of rows
  sensorId  Int
  sensor    Sensor   @relation(fields: [sensorId], references: [id], onDelete: Cascade)
  
  value     Float
  timestamp DateTime @default(now())

  @@index([sensorId, timestamp]) // Crucial for fast graph queries
}

// Automation Rules
model AlertRule {
  id          Int      @id @default(autoincrement())
  farmId      Int
  farm        Farm     @relation(fields: [farmId], references: [id])
  
  // Optional: Bind to specific sensor, or applies to all sensors of a type
  sensorId    Int?
  sensor      Sensor?  @relation(fields: [sensorId], references: [id])
  
  metric      String   // "temperature", "battery"
  condition   String   // "greater_than", "less_than"
  threshold   Float
  
  // Notification configuration
  contactType String   // "email", "sms", "app"
  contactDest String   // "admin@example.com" or phone number
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// Agricultural Knowledge Base
model CropProfile {
  id          Int      @id @default(autoincrement())
  region      String   // e.g., "Karadeniz"
  name        String   // e.g., "Buğday"
  category    String?  // "Tahıl", "Meyve"
  
  // General Requirements
  soilType    String?  // "Killi-tınlı", "Alüvyonal"
  waterReq    String?  // "Yaz sulaması", "Bol su"
  minRain     Int?     // mm (Annual)
  
  stages      CropStage[] // Relation to detailed stages
  
  description String?  // General notes
  created_at  DateTime @default(now())
}

model CropStage {
  id            Int         @id @default(autoincrement())
  cropProfileId Int
  cropProfile   CropProfile @relation(fields: [cropProfileId], references: [id], onDelete: Cascade)
  
  name          String      // "Filizlenme", "Olgunlaşma", "Hasat", "Genel"
  
  // Stage Specific Requirements
  minTemp       Float?      // C
  maxTemp       Float?      // C
  idealMin      Float?      // C
  idealMax      Float?      // C
  
  minHum        Float?      // %
  maxHum        Float?      // %
  
  conditions    String?     // Specific text rules: "Kuru hava", "Yağış gerekli"
}

model WeatherLog {
  id          Int      @id @default(autoincrement())
  station_id  Int
  raw_json    Json     // Original data from MGM for verification
  risk_flags  Json     // Calculated risk flags
  recorded_at DateTime @default(now())
}
