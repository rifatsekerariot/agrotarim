generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password_hash String
  created_at    DateTime @default(now())
  farms         Farm[]
}

model Farm {
  id          Int      @id @default(autoincrement())
  user_id     Int
  city        String
  district    String
  station_id  Int      // MGM Station ID
  crop_type   String?
  user        User     @relation(fields: [user_id], references: [id])
  polygon     Json?    // Storing coordinates as JSON
  plantingDate DateTime?
  devices     Device[]
  alertRules  AlertRule[]
  dashboardConfig Json?    // Stores custom dashboard layout: { widgets: [] }
  created_at  DateTime @default(now())
}

// The physical hardware box (Node/Gateway)
model Device {
  id            Int      @id @default(autoincrement())
  farmId        Int
  farm          Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name          String   // e.g. "North Field Station"
  serialNumber  String   @unique // MAC or Unique Hardware ID
  model         String?  // e.g. "AgroNode-V1"
  firmwareVer   String?
  
  // Status Monitoring
  batteryLevel  Int?     // Percentage
  signalQuality Int?     // RSSI or percentage
  status        String   @default("offline") // online, offline, maintenance
  lastSeen      DateTime?
  
  telemetryMappings Json? // Store custom parsing rules: {"temp": "t_air", "hum": "h_air"}

  sensors       Sensor[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// A specific probe on a defined Device (e.g. "Air Temp", "Soil Moisture Depth 1")
model Sensor {
  id          Int      @id @default(autoincrement())
  deviceId    Int
  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  name        String   // User friendly name: "Soil Sensor 1"
  code        String   // System identifier: "soil_vwc_1", "air_temp"
  type        String   // "temperature", "humidity", "moisture", "pressure"
  unit        String   // "C", "%", "hPa"
  
  telemetry   Telemetry[]
  alertRules  AlertRule[]
}

// Time-series data storage
model Telemetry {
  id        BigInt   @id @default(autoincrement()) // BigInt for millions of rows
  sensorId  Int
  sensor    Sensor   @relation(fields: [sensorId], references: [id], onDelete: Cascade)
  
  value     Float
  timestamp DateTime @default(now())

  @@index([sensorId, timestamp]) // Crucial for fast graph queries
}

// Automation Rules
model AlertRule {
  id          Int      @id @default(autoincrement())
  farmId      Int
  farm        Farm     @relation(fields: [farmId], references: [id])
  
  // Optional: Bind to specific sensor, or applies to all sensors of a type
  sensorId    Int?
  sensor      Sensor?  @relation(fields: [sensorId], references: [id])
  
  metric      String   // "temperature", "battery"
  condition   String   // "greater_than", "less_than"
  threshold   Float
  
  // Notification configuration
  contactType String   // "email", "sms", "app"
  contactDest String   // "admin@example.com" or phone number
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// Agricultural Knowledge Base
model CropProfile {
  id          Int      @id @default(autoincrement())
  region      String   // e.g., "Karadeniz"
  name        String   // e.g., "Buğday"
  category    String?  // "Tahıl", "Meyve"
  
  // General Requirements
  soilType    String?  // "Killi-tınlı", "Alüvyonal"
  waterReq    String?  // "Yaz sulaması", "Bol su"
  minRain     Int?     // mm (Annual)
  
  stages      CropStage[] // Relation to detailed stages
  
  description String?  // General notes
  created_at  DateTime @default(now())
}

model CropStage {
  id            Int         @id @default(autoincrement())
  cropProfileId Int
  cropProfile   CropProfile @relation(fields: [cropProfileId], references: [id], onDelete: Cascade)
  
  name          String      // "Filizlenme", "Olgunlaşma", "Hasat", "Genel"
  
  // Stage Specific Requirements
  minTemp       Float?      // C
  maxTemp       Float?      // C
  idealMin      Float?      // C
  idealMax      Float?      // C
  
  minHum        Float?      // %
  maxHum        Float?      // %
  
  conditions    String?     // Specific text rules: "Kuru hava", "Yağış gerekli"
}

model WeatherLog {
  id          Int      @id @default(autoincrement())
  station_id  Int
  raw_json    Json     // Original data from MGM for verification
  risk_flags  Json     // Calculated risk flags
  recorded_at DateTime @default(now())
}
